<html lang="en"></html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script type="text/javascript" src="/js/jquery.min.js"></script>

    <script type="text/javascript" src="/js/moment.min.js"></script>
    <script type="text/javascript" src="/js/daterangepicker.min.js"></script>
    <link rel="stylesheet" type="text/css" href="/css/daterangepicker.css" />

    <link rel="stylesheet" href="/css/datatables.min.css">
    <script src="/js/datatables.min.js"></script>

    <title>📊 Dáta dielu AS18 - Montážna linka Stellantis</title>
    <style>
        html {
            background-color: #222;
            color: #ddd;
            font-family: 'Courier New', Courier, monospace;
        }
        a:link, a:visited, a:hover, a:active {
            color: #ddd;
        }
    </style>
</head>
<body>
    <p style="display: inline;">📊 Dáta dielu AS18 - Montážna linka Stellantis</p>
    <input type="text" name="daterange">
    <a href="api/download-csv" download="export.csv" id="dcsv">Download CSV</a>
    <main>
        <table id="myTable" class="nowrap">
            <thead>
                <tr id="tableHeadRow"></tr>
            </thead>
        </table>
    </main>
</body>

<script>
    const format = "YYYY-MM-DDTHH:mm:ss"
    let table = null
    let curStart = moment().startOf('day').format(format)
    let curEnd = moment().endOf('day').format(format)
    let columns = []

    const formatTime = timeStr => timeStr ? timeStr.replace("Z", "").replace("T", " ").substring(0, timeStr.indexOf('.')) : timeStr

    const addData = () => {
        const href = encodeURI(`api/download-csv?start=${curStart}&end=${curEnd}`)
        const dcsv = $('#dcsv') 
        dcsv.attr('href', href)
        dcsv.attr("download", `as18_export_${curStart.replaceAll(":", ".")}_${curStart.replaceAll(":", ".")}.csv`)

        if (table) table.destroy()
        const url = encodeURI(`/api/data-dielu?start=${curStart}&end=${curEnd}`)
        table = $('#myTable').DataTable({
            ajax: {
                url: url,
                dataSrc: ''
            },
            order: [[0, 'desc']],
            columns: columns,
            pageLength: 100,
        })
    }

    $(document).ready(function () {
        fetch("/api/columns/data_dielu")
        .then(res => res.json())
        .then(cols => {
            const tr = document.getElementById("tableHeadRow")
            for (const col of cols) {
                const td = document.createElement("td")
                td.textContent = col.data.replaceAll("_", " ").toUpperCase()
                tr.appendChild(td)

                columns.push({ data: col.data, render: col.render === "formatTime" ? formatTime : undefined })
            }
            addData()
        })
    })

    $(function() {
        $('input[name="daterange"]').daterangepicker({
            startDate: moment().startOf('day'),
            endDate: moment().endOf('day'),
            showCustomRangeLabel: true,
            showWeekNumbers: true,
            timePicker: true,
            timePickerIncrement: 15,
            timePicker24Hour: true
        }, function(start, end, label) {
            const formatedStart = start.format(format)
            const formatedEnd = end.format(format)
            curStart = formatedStart
            curEnd = formatedEnd
            addData()
        });
    });
</script>
</html>